# Feature Specification: Event PIN Access

**Feature Branch**: `006-event-pin-access`  
**Created**: 2025-01-27  
**Status**: Draft  
**Input**: User description: "Event access

1. Every event will have a 6 digit PIN associated with it. It is created automatically upon even creation. An admin can regenerate a new pin from the event admin screen.

2. A regular user needs this PIN to access the event. A regular user does not need to go through the OTP flow to access an event.

3. An event admin can also access the event via the PIN

4. The /event/:eventid/admin page can only be accessed via OTP

5. If the admin has accessed an event via PIN and then attempts to navigate to the admin page the OTP flow has to be presented."

## Clarifications

### Session 2025-01-27

- Q: Test OTP bypass for development/testing - Should the test OTP "123456" (from spec 003-otp-auth) also work for OTP authentication when accessing admin pages in development/test environments? → A: Use test OTP "123456" in dev/test environments only (same as OTP auth spec) - The test OTP "123456" should be accepted for any email address in development and test environments only when accessing admin pages, bypassing email delivery for faster testing, consistent with the OTP authentication feature behavior
- Q: PIN entry UI location - Where should the PIN entry interface be displayed when a user navigates to an event without PIN verification? → A: Full-page PIN entry screen similar to OTP entry - PIN entry should use a similar UI pattern to OTP entry (full page with card component), replacing the event content until PIN is verified, since PIN entry replaces OTP authentication for regular users accessing events
- Q: PIN attempt rate limiting - What are the specific rate limits for PIN entry attempts, and what happens when limits are exceeded? → A: Similar to OTP rate limiting - Apply rate limiting similar to OTP authentication: limit PIN attempts per IP address and per event independently (e.g., 5 attempts per IP per 15 minutes AND 5 attempts per event per 15 minutes), with temporary lockout after exceeding limits, consistent with OTP authentication security patterns
- Q: PIN verification session duration - How long should PIN verification sessions remain valid before requiring re-entry? → A: No expiration (valid until PIN regenerated or event ends) - PIN verification sessions remain valid indefinitely until either the PIN is regenerated by an administrator or the event state becomes "finished", providing persistent access without requiring re-entry during active event participation

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Regular User Accesses Event via PIN (Priority: P1)

A regular user (not an event administrator) wants to access an event. They navigate to the event URL and are prompted to enter a 6-digit PIN. Upon entering the correct PIN, they gain access to the event main page without needing to complete OTP authentication.

**Why this priority**: This is the primary access method for regular users. Without PIN-based access, regular users cannot participate in events. This must work independently to enable event participation.

**Independent Test**: Can be fully tested by navigating to an event URL, entering a valid PIN, and verifying that access is granted to the event main page without requiring OTP authentication.

**Acceptance Scenarios**:

1. **Given** a user navigates to `/event/<event-id>`, **When** they are not authenticated and have not entered a PIN, **Then** the system displays a full-page PIN entry screen (similar to OTP entry UI pattern) prompting them to enter the 6-digit PIN for the event
2. **Given** a user enters a valid 6-digit PIN, **When** they submit the PIN, **Then** the system grants access to the event main page and stores PIN verification state
3. **Given** a user enters an invalid PIN, **When** they submit the PIN, **Then** the system displays an error message and allows them to retry
4. **Given** a user enters a PIN with incorrect format (not 6 digits), **When** they attempt to submit, **Then** the system displays a validation error indicating the PIN must be exactly 6 digits
5. **Given** a user has successfully entered a PIN and accessed an event, **When** they navigate to a different event, **Then** the system prompts them to enter the PIN for the new event
6. **Given** a user has successfully entered a PIN for an event, **When** they navigate away and return to the same event within the session, **Then** the system remembers their PIN verification and grants immediate access

---

### User Story 2 - Event Administrator Accesses Event via PIN (Priority: P1)

An event administrator wants to access their event using the PIN instead of OTP authentication. They navigate to the event URL, enter the 6-digit PIN, and gain access to the event main page. However, if they attempt to access the admin page, they must complete OTP authentication.

**Why this priority**: This provides administrators with a convenient way to access events while maintaining security for admin functions. This must work independently to enable administrator access patterns.

**Independent Test**: Can be fully tested by navigating to an event URL as an administrator, entering a valid PIN, verifying access to the event main page, then attempting to access the admin page and verifying that OTP authentication is required.

**Acceptance Scenarios**:

1. **Given** an event administrator navigates to `/event/<event-id>`, **When** they enter the correct PIN, **Then** the system grants access to the event main page
2. **Given** an administrator has accessed an event via PIN, **When** they navigate to `/event/<event-id>/admin`, **Then** the system redirects them to the OTP authentication flow
3. **Given** an administrator completes OTP authentication after accessing via PIN, **When** they access the admin page, **Then** the system grants access to the admin page
4. **Given** an administrator has completed OTP authentication, **When** they navigate between the event main page and admin page, **Then** the system allows access to both pages without requiring PIN re-entry
5. **Given** an administrator accesses an event via PIN, **When** they attempt to perform admin actions on the main page, **Then** the system prompts them to complete OTP authentication to access admin functionality

---

### User Story 3 - PIN Generation and Regeneration (Priority: P2)

When an event is created, the system automatically generates a 6-digit PIN associated with that event. Event administrators can regenerate a new PIN from the event admin screen, which invalidates the previous PIN.

**Why this priority**: This establishes the PIN lifecycle management. While not required for initial PIN-based access, it enables administrators to manage event security. This can be tested independently by verifying PIN generation and regeneration functionality.

**Independent Test**: Can be fully tested by creating a new event and verifying that a 6-digit PIN is automatically generated, then accessing the admin screen and regenerating the PIN, verifying that the old PIN no longer works.

**Acceptance Scenarios**:

1. **Given** a new event is created, **When** the event is first created, **Then** the system automatically generates a unique 6-digit PIN and associates it with the event
2. **Given** an event administrator is on the admin page, **When** they request to regenerate the PIN, **Then** the system generates a new 6-digit PIN and invalidates the previous PIN
3. **Given** an administrator regenerates a PIN, **When** users attempt to access the event using the old PIN, **Then** the system rejects the old PIN and prompts for the new PIN
4. **Given** an administrator regenerates a PIN, **When** the new PIN is generated, **Then** the system displays the new PIN to the administrator (for sharing with users)
5. **Given** an administrator regenerates a PIN, **When** users who previously accessed via the old PIN attempt to access the event, **Then** the system prompts them to enter the new PIN

---

### Edge Cases

- What happens when a user enters a PIN for a non-existent event? (Should validate event exists before PIN validation)
- How does the system handle PIN entry attempts with rate limiting? (Rate limiting applies independently to both IP addresses and events, e.g., 5 attempts per IP per 15 minutes AND 5 attempts per event per 15 minutes, with temporary lockout when limits are exceeded)
- What happens when an administrator regenerates a PIN while users are actively accessing the event? (Should handle gracefully, potentially allowing current sessions to continue or requiring re-authentication)
- How does the system handle PIN verification state expiration? (PIN verification sessions remain valid until the PIN is regenerated or the event state becomes "finished", with no time-based expiration)
- What happens when a user enters an incorrect PIN multiple times? (Should implement rate limiting or temporary lockout)
- How does the system handle concurrent PIN regeneration requests? (Should process sequentially to prevent race conditions)
- What happens when an administrator accesses via PIN, then their OTP session expires while on the admin page? (Should require re-authentication via OTP)
- How does the system handle PIN access when the event is deleted? (Should validate event exists before allowing PIN entry)
- What happens when a user navigates directly to `/event/<event-id>/admin` without PIN or OTP authentication? (Should require OTP authentication, not PIN)
- How does the system handle PIN verification for events that have been finished or archived? (Should allow PIN access but potentially restrict functionality based on event state)
- What happens when an administrator regenerates a PIN multiple times in quick succession? (Should handle gracefully, ensuring only the latest PIN is valid)
- How does the system store and validate PIN verification state? (Should use secure session storage or tokens)
- What happens when an administrator regenerates a PIN while users have active PIN verification sessions? (Should invalidate existing sessions and require users to enter the new PIN)
- How does the system handle PIN entry for events where the administrator email has changed? (Should validate PIN independently of administrator changes)

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST automatically generate a unique 6-digit PIN when an event is created and associate it with that event
- **FR-002**: System MUST require regular users to enter the correct 6-digit PIN to access event pages at `/event/<event-id>`
- **FR-003**: System MUST allow regular users to access events via PIN without requiring OTP authentication
- **FR-004**: System MUST allow event administrators to access events via PIN (in addition to OTP authentication)
- **FR-005**: System MUST require OTP authentication for access to `/event/<event-id>/admin` pages, regardless of how the user accessed the event main page
- **FR-006**: System MUST redirect administrators who accessed an event via PIN to the OTP authentication flow when they attempt to navigate to the admin page
- **FR-007**: System MUST allow event administrators to regenerate a new 6-digit PIN from the event admin screen
- **FR-008**: System MUST invalidate the previous PIN when an administrator regenerates a new PIN
- **FR-009**: System MUST validate that PINs are exactly 6 digits before processing
- **FR-010**: System MUST store PIN verification state to allow users to access the event without re-entering the PIN, with sessions remaining valid until the PIN is regenerated or the event state becomes "finished"
- **FR-011**: System MUST validate that an event exists before allowing PIN entry
- **FR-012**: System MUST display appropriate error messages when users enter incorrect PINs
- **FR-013**: System MUST prevent access to admin pages using PIN verification alone
- **FR-014**: System MUST maintain separate authentication states for PIN-based access and OTP-based access
- **FR-015**: System MUST allow administrators who have completed OTP authentication to access both the event main page and admin page without PIN re-entry
- **FR-016**: System MUST display the new PIN to administrators after regeneration for sharing purposes
- **FR-017**: System MUST implement rate limiting to prevent brute force attacks on PINs, applying limits independently to both IP addresses and events (e.g., 5 attempts per IP per 15 minutes AND 5 attempts per event per 15 minutes), with temporary lockout when limits are exceeded
- **FR-018**: System MUST accept test OTP "123456" for any email address in development and test environments only (not in production) when accessing admin pages, bypassing email delivery, OTP generation, rate limiting, suspension, expiration, and failed attempt tracking for testing purposes, consistent with the OTP authentication feature behavior

### Key Entities *(include if feature involves data)*

- **Event PIN**: Represents a 6-digit access code for an event. Key attributes: 6-digit numeric code, associated event ID, generation timestamp, validity status (active/invalidated). PINs are automatically generated when events are created and can be regenerated by event administrators. Only one active PIN exists per event at a time; regenerating a PIN invalidates the previous one.

- **PIN Verification Session**: Represents a user's authenticated access to an event via PIN. Key attributes: event ID, PIN verification timestamp, session expiration timestamp, user identifier (if available). This session allows users to access the event main page without re-entering the PIN, but does not grant access to admin pages.

- **Event Access Method**: Represents how a user accessed an event. Valid methods: PIN-based access (grants access to main page only), OTP-based access (grants access to both main page and admin page). The system tracks which method was used to determine access permissions.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Users can access events via PIN entry in under 10 seconds from navigation to event page access (excluding PIN entry time)
- **SC-002**: 95% of PIN entry attempts with valid PINs result in successful event access
- **SC-003**: System generates unique 6-digit PINs for 100% of newly created events
- **SC-004**: 100% of admin page access attempts by users who accessed via PIN are redirected to OTP authentication
- **SC-005**: PIN regeneration completes within 2 seconds and invalidates previous PINs immediately (100% of regenerated PINs invalidate previous PINs)
- **SC-006**: Regular users can access events without OTP authentication when using valid PINs (100% of valid PIN entries bypass OTP requirement for main page access)
- **SC-007**: System validates PIN format (6 digits) and rejects invalid formats within 500 milliseconds of submission
- **SC-008**: Administrators can regenerate PINs from the admin screen in under 3 seconds from request to new PIN display
- **SC-009**: System prevents unauthorized access to admin pages via PIN verification (100% of admin page access requires OTP authentication)
- **SC-010**: PIN verification sessions persist until PIN regeneration or event completion (users do not need to re-enter PIN when navigating within the same event, unless PIN is regenerated or event becomes "finished")

## Assumptions

- PINs are stored securely server-side and associated with events
- PIN verification state is stored in session storage or secure tokens
- PIN entry UI is presented as a full-page screen (similar to OTP entry UI pattern) before allowing access to event pages, replacing event content until PIN is verified
- Event creation process includes automatic PIN generation
- PIN regeneration is available only to event administrators
- OTP authentication system is already implemented and functional (from feature 003-otp-auth)
- Test OTP "123456" from OTP authentication system applies to this feature, allowing bypass of email OTP verification in development and test environments for accessing admin pages, consistent with the OTP authentication feature behavior
- Event data model includes a field for storing the PIN
- PIN verification does not require user email or other identifying information beyond the PIN itself
- PIN-based access sessions remain valid indefinitely until the PIN is regenerated by an administrator or the event state becomes "finished", providing persistent access without requiring re-entry during active event participation
- Administrators can view the current PIN on the admin screen for sharing purposes
- PIN regeneration invalidates previous PINs immediately, and all existing PIN verification sessions are invalidated when a PIN is regenerated (per FR-008)
- Rate limiting is implemented similar to OTP authentication: limits apply independently to both IP addresses and events (e.g., 5 attempts per IP per 15 minutes AND 5 attempts per event per 15 minutes), with temporary lockout when limits are exceeded, consistent with OTP authentication security patterns
- PIN entry is required per event (entering a PIN for one event does not grant access to other events)
- The system distinguishes between PIN-based access and OTP-based access to enforce admin page restrictions
- Event administrators are identified by email address stored in the event's administrator field
- PIN format validation occurs both client-side and server-side

## Dependencies

- Event creation feature (spec 004-create-event) for automatic PIN generation during event creation
- OTP authentication system (spec 003-otp-auth) for admin page access requirements
- Event feature (spec 005-event-feature) for event page structure and admin page implementation
- Event data model and storage infrastructure for storing PINs
- Session management or token system for PIN verification state
- Frontend routing and authentication middleware for PIN entry flow
- Admin page UI components for PIN regeneration functionality

## Out of Scope

- PIN expiration or automatic rotation (PINs remain valid until manually regenerated)
- PIN sharing or distribution mechanisms (administrators share PINs manually)
- PIN history or audit logging (tracking which PINs were used when)
- Multiple PINs per event (only one active PIN per event)
- PIN-based access for admin pages (admin pages always require OTP)
- PIN complexity requirements beyond 6 digits (format is fixed)
- PIN recovery or reset mechanisms (administrators regenerate new PINs)
- User accounts or profiles for PIN-based access (PINs work without user accounts)
- PIN-based access permissions or role management (PIN grants same access level to all users)
- Integration with external PIN management systems
- PIN encryption or hashing requirements (implementation detail, but PINs should be stored securely)
